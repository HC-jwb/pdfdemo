<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  	<link rel="stylesheet" type="text/css" href="/css/nprogress.css">
  	<link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="/css/modules.min.css">
	<link rel="stylesheet" type="text/css" href="/css/scrolltabs.css">
	<link rel="stylesheet" type="text/css" href="/css/report.css">
<style>
	.right-column-content-container {min-width: 1000px;}
	.ui.form .field input {padding: 0.5em;}
	.plain-text {font-weight: normal; font-size: 0.85em;}
</style>
	<title>Next Generation Smart FMS Platform</title>
</head>
<body>
<div class="ui fixed main secondary small blue inverted menu" id="topMenu">
	<div class="ui container">
		<a class="tracking enabled item"><i class="road icon"></i> Vehicle Tracking</a>
		<a class="fuel report enabled item"><i class="bar chart icon"></i> Fuel Efficiency</a>
		<a class="filling report enabled item"><i class="chart line icon"></i> Filling</a>
		<a class="draining report item"><i class="chart line icon"></i> Draining</a>
		<a class="vehicle tax active enabled item"><i class="yellow tasks icon"></i> Vehicle Tax</a>
		<div class="right menu">
			<a class="ui logout item" href="/login.html" title="Sign out"><i class="sign-out icon"></i></a>
		</div>
	</div>
</div>

<div class="main-container">
	<div class="left-column">
		<div class="ui raised segment">
			<div class="ui blue top attached label">Vehicle Tax Management</div>
			<div class="left-column-content-container">
				<div class="ui blue vertical fluid secondary pointing small menu" id="taxSubMenu">
					<a class="payment task item"><i class="bell icon"></i>Vehicle Tax Payment Task</a>
					<a class="active tax template item"><i class="copy icon"></i>Payment Task Templates</a>
	   			</div>
	   		</div>
		</div>
	</div>
	<div class="right-column">
		<div class="right-column-content-container">
			<div class="ui small form" style="padding-top: 0.5em;">
				<div class="fields">
					<div class="ten wide field"><div class="ui tag label">Templates for tax payment task</div></div>
					<div class="six wide inline field" style="text-align: right"><div class="ui compact icon add tiny basic button" title="Add new template"><i class="orange plus squre icon"></i></div></div>
				</div>
			</div>
			<div class="ui basic segment" style="padding: 0;margin: 0;">
				<div class="ui loader"  id="tableLoader"></div>
				<table class="ui celled teal striped compact small table" id="tmplListTable" style="margin-top: 0.5em;">
					<thead>
					<tr>
						<th class="center aligned">No.</th>
						<th class="center aligned">Service Title</th><th class="center aligned">Description</th>
						<th class="center aligned">Email</th><th class="center aligned">SMS</th>
						<th class="center aligned collapsing">Edit/Remove</th>
					</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>		
		</div><!-- end of right column content container -->
	</div><!--  end of right column -->
</div><!-- end of main -->
<div class="ui segment modal" id="templateModal">
	<div class="ui small form">
		<div class="fields">
			<div class="five wide field">
				<label>Service Title</label>
				<input type="text" name="title" placeHolder="Enter service title">
			</div>

			<div class="eleven wide field">	
				<label>Description</label>
				<input type="text" name="description" placeHolder="Enter service description">
			</div>
		</div>
		<div class="fields">
			<div class="eight wide field">
				<div class="ui vhc-cert segment">
					<div class="ui blue top attached label"><i class="car icon"></i> Vehicle Certificate</div>
					<div class="inline fields">
						<label>Schedule ends on Every :</label>
						<div class="field"><div class="ui radio checkbox"><input type="radio" name="certificationInterval" value="1"><label>1 year</label></div></div>
						<div class="field"><div class="ui radio checked checkbox"><input type="radio" name="certificationInterval" value="5"><label>5 years</label></div></div>
					</div>
					<div class="inline fields">
						<label>Payment &nbsp;Cost:</label>
						<div class="field"><input type="text" name="certificationCost" class="certcost-input" placeholder="0.00" style="text-align: right;"> RP</div>
					</div>
					<div class="inline fields">
						<label>Remind Before:</label>
						<div class="field"><input type="number" name="certificationRemindBeforeDays" placeholder="0" min="0" style="text-align: right;"> days</div>
					</div>
				</div>
			</div><!--  end of vehicle certification segment containing field-->
			<div class="eight wide field">
				<div class="ui vhc-tax segment">
					<div class="ui blue top attached label"><i class="money bill alternate outline icon"></i> Vehicle Tax</div>
					<div class="inline fields">
						<label>Schedule ends on Every :</label>
						<div class="field"><div class="ui radio checked checkbox"><input type="radio" name="taxInterval" value="1"><label>1 year</label></div></div>
						<div class="field"><div class="ui radio checkbox"><input type="radio" name="taxInterval" value="5"><label>5 years</label></div></div>
					</div>
					<div class="inline fields">
						<label>Payment &nbsp;Cost:</label>
						<div class="field"><input type="text" name="taxCost" class="taxcost-input" placeholder="0.00" style="text-align: right;"> RP</div>
					</div>
					<div class="inline fields">
						<label>Remind Before:</label>
						<div class="field"><input type="number" name="taxRemindBeforeDays" placeholder="0" min="0" style="text-align: right;"> days</div>
					</div>
				</div>
			</div><!--  end of vehicle tax segment containing field-->
		</div>
		<div class="ui horizontal divider"><i class="alarm icon"></i><span class="plain-text"> Notification</span></div>
					<div class="fields">
						<div class="eight wide field"><label><i class="comments alternate icon"></i>SMS notification</label><input type="text" name="notificationSms"></div>
						<div class="eight wide email field"><label><i class="envelope icon"></i>Email notification</label><input type="text" name="notificationEmail"></div>
					</div>
		<div class="field">
			<div class="ui small message"><i class="hand point right outline icon"></i>Notifications will always be available on web interface UI</div>
		</div>
		<div class="error-description field"></div>
		<div class="field">
			<div style="text-align: center;">
				<div class="ui blue right labeled icon small basic save compact button">Save<i class="save icon"></i></div>
				<div class="ui right labeled icon small basic close compact button">Close <i class="x icon"></i></div>
			</div>	
		</div>
	</div>
</div>
<script src="/js/nprogress.js"></script>
<script src="/js/jquery-3.1.1.min.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/jquery.tablesort.min.js"></script>
<script src="/js/modules.min.js"></script>
<script src="/js/cleave.min.js"></script>
<script src="/js/common.api.js"></script>
<script src="/js/common.js?v=1.1"></script>
<script>
var TaxServiceApi = {
	apiBase:'/vhctax/api/',
	saveTemplateUri: 'tmpl/save',
	getPaymentTemplateUri: 'tmpl/get',
	removeTemplateUri:'tmpl/remove',
	listTemplateUri:'tmpl/list',
	savePaymentTemplate: function(tmplJson, callback) {
		Api.postJson(this.apiBase + this.saveTemplateUri, tmplJson, callback, function(response) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	},
	removePaymentTemplate: function(id, callback) {
		Api.sendGet(this.apiBase + this.removeTemplateUri + '/' + id, callback, function(res) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	},
	listPaymentTemplate: function(callback) {
		Api.sendGet(this.apiBase + this.listTemplateUri, callback, function(res) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	},
	getPaymentTemplate: function(id, callback) {
		Api.sendGet(this.apiBase + this.getPaymentTemplateUri + '/' + id, callback, function(res) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	}
};
function saveTemplate() {
	$form.form("validate form");
	if(!$form.form('is valid')) return;
	var svcTmpl = $form.form('get values');
	svcTmpl.id = $form.data("id");/*if id is not null, it means updating existing template*/
	svcTmpl.notificationEmail = $.trim(svcTmpl.notificationEmail);
	if(svcTmpl.notificationEmail && !validateEmail(svcTmpl.notificationEmail)) {
		$form.find(".email.field").addClass("error");
		return;
	}
	svcTmpl.certificationCost = svcTmpl.certificationCost.replace(/\,/g,"");
	svcTmpl.taxCost = svcTmpl.taxCost.replace(/\,/g,"");
	TaxServiceApi.savePaymentTemplate(svcTmpl, function(response) {
		if(response.success) {
			console.log(response.payload);
			listServiceTemplate();
		} else {
			FormUI.displayMsgIn($form, response.status.description);
		}
	});
}
function listServiceTemplate() {
	$tableLoader.addClass("active");
	TaxServiceApi.listPaymentTemplate(function(response) {
		if(response.success) {
			buildTemplateListTable(response.payload);
			hideModal();
		} else {
			alert(response.status.description);
		}
		setTimeout(function() {$tableLoader.removeClass("active")}, 200);
	});
}
function buildTemplateListTable(tmplList) {
	var $TBODY = $tmplListTable.find("tbody");
	$TBODY.empty();
	var len = tmplList.length;
	if(len) {
		var $TR = $("<tr></tr>");
		var $clone;
		for(var i = 0; i < len; i++) {
			$clone = $TR.clone(false);
			$clone.data('tmplid', tmplList[i].id);
			$clone.append("<td class='right aligned collapsing'>" +(i+1) + "</td>");
			$clone.append("<td>" +tmplList[i].title+"</td>");
			$clone.append("<td>" +tmplList[i].description+"</td>");
			$clone.append("<td class='collapsing'>" +tmplList[i].notificationEmail+"</td>");
			$clone.append("<td class='collapsing'>" +tmplList[i].notificationSms+"</td>");
			$clone.append("<td class='center aligned'><div class='ui mini compact icon blue edit basic button' title='view and edit template'><i class='edit icon'></i></div><div class='ui mini compact icon red basic delete button' title='remove template'><i class='trash alternate icon'></i></div></td>");
			$TBODY.append($clone);
		}
	} else {
		$TBODY.append("<tr><td colspan='6' class='center aligned'>No template found.</td></tr>");
	}
}

function loadPaymentTemplateForEdit(id) {
	TaxServiceApi.getPaymentTemplate(id, function(response) {
		if(response.success) {
			showModal(response.payload);
		} else {
			alert(response.status.description);
		}
	});
}
function removePaymentTemplate(id) {
	$tableLoader.addClass("active");
	TaxServiceApi.removePaymentTemplate(id, function(response) {
		if(response.success) {
			listServiceTemplate();
		} else {
			alert(response.status.description);
		}
	});
}
function showModal(tmpl) {
	$form.data('id', null);
	$form.form('clear');
	if(typeof(tmpl) === 'undefined' ) {
		$('.ui.radio.checked.checkbox').checkbox('set checked');
	} else {
		$form.data('id', tmpl.id);
		tmpl.certificationCost = addCommas(tmpl.certificationCost);
		tmpl.taxCost = addCommas(tmpl.taxCost);
		$form.form('set values', tmpl);
	}
	
	$templateModal.modal("show");
}
function hideModal() {
	$templateModal.modal("hide");
	FormUI.resetMsgIn($form);
}
var $templateModal, $form, $tmplListTable, $loadingSegment;
$(function() {
	$(".ui.radio.checkbox").checkbox();
	$tmplListTable = $("#tmplListTable");
	$templateModal = $("#templateModal");
	$tableLoader = $("#tableLoader");
	$templateModal.modal({dimmerSettings:{opacity: 0.3}, autofocus:false, closable:false});
	$form = $templateModal.find(".ui.form");
	$form.form({fields: {title:'empty', description:'empty', certificationCost:'number', certificationCost:'empty', taxCost:'empty'}});
	
	$tmplListTable.on("click", "tbody > tr > td > .ui.button", function() {
		var $this = $(this);
		var id = $this.parent().parent().data("tmplid");
		if($this.hasClass("edit")) {
			loadPaymentTemplateForEdit(id);
		} else if($this.hasClass("delete")) {
			removePaymentTemplate(id);
		}
	});
	$form.find(".ui.button").click(function() {
		var $this = $(this);
		if($this.hasClass("close")) {
			hideModal();
		} else if($this.hasClass("save")) {
			saveTemplate();
		}
	});
	$(".ui.add.button").click(function() {showModal(); });
	var cleave = new Cleave('.taxcost-input', {
	    numeral: true,
	    numeralThousandsGroupStyle: 'thousand'
	});
	cleave = new Cleave('.certcost-input', {
	    numeral: true,
	    numeralThousandsGroupStyle: 'thousand'
	});
	listServiceTemplate();
});
</script>
</body>
</html>