<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  	<link rel="stylesheet" type="text/css" href="/css/nprogress.css">
  	<link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="/css/modules.min.css">
	<link rel="stylesheet" type="text/css" href="/css/scrolltabs.css">
	<link rel="stylesheet" type="text/css" href="/css/report.css">
<style>
	.right-column-content-container {min-width: 1000px;}
	.ui.form .field input {padding: 0.5em;}
	.plain-text {font-weight: normal !important; font-size: 0.9em !important;}
	.ui.checkbox.no-label {font-size: 0;}
	.ui.small.tax.form .fields {margin-bottom: 0.35em;}
	.tax-reg-photo {width: 100px; height: 80px;}
	.ui.table > tbody > tr.selected {background-color: #4085e5; color: white;}
	img.tax-reg-photo:hover {cursor: pointer;}
</style>
	<title>Next Generation Smart FMS Platform</title>
</head>
<body>
<div class="ui fixed main secondary small blue inverted menu" id="topMenu">
	<div class="ui container">
		<a class="tracking enabled item"><i class="road icon"></i> Vehicle Tracking</a>
		<a class="fuel report enabled item"><i class="bar chart icon"></i> Fuel Efficiency</a>
		<a class="filling report enabled item"><i class="chart line icon"></i> Filling</a>
		<a class="draining report item"><i class="chart line icon"></i> Draining</a>
		<a class="vehicle tax active enabled item"><i class="yellow tasks icon"></i> Vehicle Tax</a>
		<div class="right menu">
			<a class="ui logout item" href="/login.html" title="Sign out"><i class="sign-out icon"></i></a>
		</div>
	</div>
</div>

<div class="main-container">
	<div class="left-column">
		<div class="ui raised segment">
			<div class="ui blue top attached label"><i class="rupee sign icon"></i>Vehicle Tax Management</div>
			<div class="left-column-content-container">	
				<div class="ui blue vertical fluid secondary pointing small menu" id="taxSubMenu">
					<a class="active payment task item"><i class="bell icon"></i>Vehicle Tax Payment Task</a>
					<a class="tax template item"><i class="copy icon"></i>Payment Task Templates</a>
	   			</div>
	   		</div>
		</div>
	</div>
	<div class="right-column">
		<div class="right-column-content-container">
			<div class="ui small form" id="actionFrm" style="padding-top: 0.5em;">
				<div class="inline fields">
<!--				
					<div class="four wide field">
						<label>Group by:</label>
						<div class="ui selection dropdown" style="min-width: 11em;">
							<i class="dropdown icon"></i>
							<div class="default text">Do not Group By</div>
							<div class="ui menu">
								<div class="item" data-value="garage">Garage</div>
								<div class="item" data-value="fuel">Fuel Type</div>
								<div class="item" data-value="vtype">Vehicle Type</div>
							</div>
						</div>
					</div>
--> 
					<div class="four wide field">
						<label>Payment type:</label>
						<div class="ui selection dropdown" style="min-width: 11em;">
							<i class="dropdown icon"></i>
							<div class="default text">All</div>
							<div class="ui menu">
								<div class="item" data-value="x">Certification No.</div>
								<div class="item" data-value="a">Tax No.</div>
							</div>
						</div>
					</div>
					<div class="seven wide inline field">
						<label>Period:</label>
						<div class="ui small left icon input">
							<input type="text" placeholder="Date from" id="fromDate" name="fromDate"><i class="calendar alternate outline icon"></i>
						</div>
						&nbsp;~&nbsp;
						<div class="ui small right icon input">
							<input type="text" placeholder="Date to" id="toDate" name="toDate"><i class="calendar alternate outline icon"></i>
						</div>
					</div>
					<div class="four wide field">
						<div class="ui orange tiny compact icon basic add button" title="add new tax payment task"><i class="plus icon"></i></div>
						<div class="ui tiny compact icon basic button"><i class="check icon"></i></div>
						<div class="ui tiny compact icon basic button"><i class="print icon"></i></div>
						<div class="ui tiny compact icon basic button"><i class="trash alternate icon"></i></div>
					</div>
					<div class="one wide field">
						<div class="ui compact blue search icon button"><i class="search icon"></i></div>
					</div>
				</div>
			</div>
			<table class="ui celled teal striped compact small sortable table" id="vhcListTable" style="margin-top: 0.2em;">
				<thead>
				<tr>
					<th class="center aligned collapsing"><div class="ui checkbox no-label"><input type="checkbox" name="chkAll"></div></th>
					<th class="center aligned">Label</th>
					<th class="center aligned">Model</th>
					<th class="center aligned">Plate No.</th>
					<th class="center aligned">Payment Type</th>
					<th class="center aligned">Cost</th>
					<th class="center aligned">Due Date</th>
					<th class="center aligned">Status</th>
				</tr>
				</thead>
				<tbody></tbody>
			</table>
		</div><!-- end of right column content container -->
	</div><!--  end of right column -->
</div><!-- end of main -->
<div class="ui segment modal" id="registModal">
	<div class="ui small form tax">
		<div class="fields">
			<div class="four wide field">
				<div class="ui segment" style="padding-left: 0.3em; padding-right: 0.3em;">
					<div class="ui top attached blue label"><i class="car icon"></i> Vehicle List</div>
					<div style="overflow: auto; max-height: 430px;"><table class="ui small small basic table"><tbody></tbody></table></div>
				</div>
			</div>
			<div class="twelve wide field">
				<div class="ui segment">
					<div class="ui top attached blue label">Tax Payment Task</div>
					<div class="fields">
						<div class="twelve wide field">
							<label class="plain-text"><i class="copy outline icon"></i>Apply Template</label>
							<div class="ui fluid search selection dropdown" id="templateDropdown">
								<i class="dropdown icon"></i>
								<input type="hidden" name="tmplId">
								<div class="default text">Select Template to apply</div>
								<div class="ui menu"></div>
							</div>
						</div>
					</div>
					<div class="ui horizontal divider"><i class="car grey icon"></i>&nbsp;<span class="plain-text">Vehicle Certification</span></div>
					<div class="fields">
						<div class="twelve wide field">
							<div class="fields">
								<div class="eight wide field"><label class="plain-text">Certification No.</label><div class="ui small input"><input type="text" name="certificationNo"></div></div>
								<div class="eight wide field"><label class="plain-text">Valid Till</label><div class="ui small right icon input"><input type="text" name="certificationBaseDate" id="certValidTill"><i class="calendar alternate outline icon"></i></div></div>
							</div>
							<div class="fields">
								<div class="eight wide field"><label class="plain-text">Cost</label><div class="ui small right icon input"><input type="text" class="certcost-input" name="certificationCost" style="text-align: right;"><i class="rupee icon"></i></div></div>
								<div class="eight wide field"><label class="plain-text">Remind Before</label><div class="ui small input"><input type="number" name="certificationRemindBeforeDays" style="text-align: right;"></div></div>
							</div>
						</div>
						<div class="four wide field">
							<label class="plain-text">Certification Photo</label><img class="tax-reg-photo" src="/images/dummy_photo.png">
						</div>
					</div>
					<div class="ui horizontal divider"><span class="plain-text"><i class="car grey icon"></i>&nbsp;Vehicle Tax</span></div>
					<div class="fields">
						<div class="twelve wide field">		
							<div class="fields">
								<div class="eight wide field"><label class="plain-text">Tax No.</label><div class="ui small input"><input type="text" name="taxNo"></div></div>
								<div class="eight wide field"><label class="plain-text">Valid Till</label><div class="ui small right icon input"><input type="text" name="taxBaseDate" id="taxValidTill"><i class="calendar alternate outline icon"></i></div></div>
							</div>
							<div class="fields">
								<div class="eight wide field"><label class="plain-text">Cost</label><div class="ui small right icon input"><input type="text" class="taxcost-input" name="taxCost" style="text-align: right;"><i class="rupee icon"></i></div></div>
								<div class="eight wide field"><label class="plain-text">Remind Before</label><div class="ui small input"><input type="number" name="taxRemindBeforeDays" style="text-align: right;"></div></div>
							</div>
						</div>
						<div class="four wide field">
							<label class="plain-text">Tax Photo</label><img class="tax-reg-photo" src="/images/dummy_photo.png">
						</div>
					</div>
					<div class="ui horizontal divider"><i class="grey bell icon"></i>&nbsp;<span class="plain-text">Notification</span></div>
					<div class="fields">
						<div class="eight wide field"><label class="plain-text">SMS Notification</label><div class="ui small left icon input"><input type="text" name="notificationSms"><i class="comments alternate icon"></i></div></div>
						<div class="eight wide field"><label class="plain-text">Email Notification</label><div class="ui small left icon input"><input type="text" name="notificationEmail"><i class="envelope icon"></i></div></div>
					</div>
				</div>
			</div>
		</div>
		<div class="fields">
			<div class="field"><input type="hidden" name="vehicleId"></div>
			<div class="field"><input type="hidden" name="label"></div>
			<div class="field"><input type="hidden" name="model"></div>
			<div class="field"><input type="hidden" name="regNumber"></div>
			<div class="field"><input type="hidden" name="vin"></div>
		</div>
		<div class="error-description field"></div>
		<div class="ui divider"></div>
		<div class="field">
			<div style="text-align: center;">
				<div class="ui blue right labeled icon small basic save compact button">Save<i class="save icon"></i></div>
				<div class="ui right labeled icon small basic close compact button">Close <i class="x icon"></i></div>
			</div>	
		</div>
	</div>
</div>
<script src="/js/nprogress.js"></script>
<script src="/js/jquery-3.1.1.min.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/jquery.tablesort.min.js"></script>
<script src="/js/modules.min.js"></script>
<script src="/js/cleave.min.js"></script>
<script src="/js/common.api.js"></script>
<script src="/js/common.js?v=1.1"></script>
<script>
var TaxServiceApi = {
	apiBase:'/vhctax/api/',
	saveTemplateUri: 'tmpl/save',
	getPaymentTemplateUri: 'tmpl/get',
	removeTemplateUri:'tmpl/remove',
	listTemplateUri:'tmpl/list',
	vehicleListUri:'vehicle/list',
	saveTaxPaymentTaskUri: 'task/save',
	savePaymentTemplate: function(tmplJson, callback) {
		Api.postJson(this.apiBase + this.saveTemplateUri, tmplJson, callback, function(response) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	},
	removePaymentTemplate: function(id, callback) {
		Api.sendGet(this.apiBase + this.removeTemplateUri + '/' + id, callback, function(res) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	},
	listPaymentTemplate: function(callback) {
		Api.sendGet(this.apiBase + this.listTemplateUri, callback, function(res) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	},
	getPaymentTemplate: function(id, callback) {
		Api.sendGet(this.apiBase + this.getPaymentTemplateUri + '/' + id, callback, function(res) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	},
	getVehicleList: function(callback) {
		Api.sendGet(this.apiBase + this.vehicleListUri, callback, function(res) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	},
	saveTaxPaymentTask: function(taxPaymentObj, callback) {
		Api.postJson(this.apiBase + this.saveTaxPaymentTaskUri, taxPaymentObj, callback, function(response) {
			callback({success:false, status: {description: 'Failed due to communication error!'}});
		});
	}
};

function buildVhcList(vhcList) {
	var $tbody = $registFrm.find(".ui.table > tbody:first");
	var $item = $("<tr></tr>");
	var $cloned;
	$tbody.empty();
	for(var i = 0; i < vhcList.length; i++) {
		$cloned = $item.clone(false);
		$cloned.append("<td>" + vhcList[i].label + "</td>");
		$cloned.data("vhc", vhcList[i]);
		$tbody.append($cloned);
	}
}
function buildTmplDropdown(tmplList) {
	var $item = $("<div class='item'></div>");
	var $clone;
	var $templateDropdown = $("#templateDropdown");
	var $dropdownContainer = $templateDropdown.find(".ui.menu:first");
	$dropdownContainer.empty();
	for(var i = 0; i < tmplList.length; i++) {
		$clone = $item.clone(false);
		$clone.data('value', tmplList[i].id);
		$clone.data("tmpl", tmplList[i]);
		$clone.append(tmplList[i].title);
		$dropdownContainer.append($clone);
	}
}
function applyTemplate(text, value, $item) {
	var tmpl = $item.data("tmpl");
	tmpl.certificationCost = addCommas(tmpl.certificationCost);
	tmpl.taxCost = addCommas(tmpl.taxCost);
	$registModal.find(".ui.form:first").form("set values", tmpl);
	certValidTill.datepicker( "option", "defaultDate", "+" + tmpl.certificationInterval + "y");
	taxValidTill.datepicker( "option", "defaultDate", "+" + tmpl.taxInterval + "y");
}
function applyVehicle(vhc) {
	$registFrm.form('set value', 'vehicleId', vhc.id);
	$registFrm.form('set value', 'label', vhc.label);
	$registFrm.form('set value', 'model', vhc.model);
	$registFrm.form('set value', 'regNumber', vhc.reg_number);
	$registFrm.form('set value', 'vin', vhc.vin);
	/*
	$registFrm.form('set value', '', vhc.garage_id);
	$registFrm.form('set value', '', vhc.fuel_type);
	$registFrm.form('set value', '', vhc.type);
	console.log(vhc);
	*/
	
}
function showRegistModal(addButton) {
	$addButton = $(addButton);
	$addButton.addClass("loading");
	TaxServiceApi.getVehicleList(function(response) {
		if(response.success) {
			TaxServiceApi.listPaymentTemplate(function(tmplResponse) {
				if(tmplResponse.success) {
					buildVhcList(response.payload);
					buildTmplDropdown(tmplResponse.payload);
					$registFrm.form('clear');
					$registModal.modal("show");
				} else {
					alert(tmplResponse.status.description);
				}
			});
		} else {
			alert(response.status.description);
		}
		$addButton.removeClass("loading");
	});
}
function saveRegistration() {
	if(!$registFrm.form('validate form')) return;
	var valueMap = $registFrm.form('get values');
	if(!valueMap.vehicleId) {
		FormUI.displayMsgIn($registFrm, 'Vehicle has to be selected!!');
		return;
	}
	valueMap.certificationCost = valueMap.certificationCost.replace(/\,/g,"");
	valueMap.taxCost = valueMap.taxCost.replace(/\,/g,"");
	console.log(valueMap);
	TaxServiceApi.saveTaxPaymentTask(valueMap, function(response) {
		if(response.success) {
			hideRegistModal();
		} else {
			alert(response.status.description);
		}
	});
}
function hideRegistModal() {
	$registModal.modal("hide");
	FormUI.resetMsgIn($registFrm);
}

function listTaxPaymentTask() {
	
}
var $registModal, $actionFrm, $registFrm, $templateDropdown, certValidTill, taxValidTill;
$(function() {
	$actionFrm = $("#actionFrm");
	$registModal = $("#registModal");
	$registFrm = $registModal.find(">.form");
	$templateDropdown = $("#templateDropdown");
	$registModal.modal({dimmerSettings:{opacity: 0.3}, autofocus:false, closable:false});
	$(".ui.checkbox").checkbox();
	$(".ui.dropdown").dropdown();
	$(".ui.sortable.table").tablesort();
	
	function getDate(element) {
		var date;
		try {
			date = $.datepicker.parseDate("yy-mm-dd", element.value );
		} catch(error) { date = null; }
		return date;
	}
	from = $("#fromDate").datepicker({dateFormat:'yy-mm-dd', defaultDate: "0d", numberOfMonths:2, changeMonth: true})
	.on("change", function() {
		to.datepicker("option", "minDate", getDate(this));
	}),
	to = $("#toDate" ).datepicker({dateFormat:'yy-mm-dd', defaultDate: "+4w", numberOfMonths:2, changeMonth: true})
	.on("change", function() {
		from.datepicker( "option", "maxDate", getDate(this));
	});
	from.datepicker('setDate', '0d');
	to.datepicker('setDate', '+4w');
	certValidTill = $("#certValidTill").datepicker({dateFormat: 'yy-mm-dd', numberOfMonths: 1, changeMonth: true});
	taxValidTill = $("#taxValidTill").datepicker({dateFormat: 'yy-mm-dd', numberOfMonths: 1, changeMonth: true});
	$registModal.find(".ui.table:first > tbody").on("click", "> tr", function() {
		var $this = $(this);
		$this.parent().find("tr").removeClass("selected");
		$this.addClass("selected");
		applyVehicle($this.data("vhc"));
	});
	$actionFrm.find(".ui.add.button:first").click(function() {
		showRegistModal(this);
	});
	
	$templateDropdown.dropdown({onChange: applyTemplate});
	$registFrm.form({fields: 
		{
			certificationNo: 'empty', certificationBaseDate: 'empty', certificationCost:'empty', certificationRemindBeforeDays: 'empty',
			taxNo: 'empty', taxBaseDate: 'empty', taxCost:'empty', taxRemindBeforeDays: 'empty'
		}
	});
	$registFrm.find(".ui.button").click(function() {
		var $this = $(this);
		if($this.hasClass("close")) {
			hideRegistModal();
		} else if($this.hasClass("save")) {
			saveRegistration();
		}
	});
	var cleave = new Cleave('.taxcost-input', {
	    numeral: true,
	    numeralThousandsGroupStyle: 'thousand'
	});
	cleave = new Cleave('.certcost-input', {
	    numeral: true,
	    numeralThousandsGroupStyle: 'thousand'
	});
	
	listTaxPaymentTask();
});
</script>
</body>
</html>